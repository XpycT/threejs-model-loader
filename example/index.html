<!DOCTYPE html>
<html>
<head>
	<title>THREEjs Model Loader</title>

	<script src="../node_modules/jszip/dist/jszip.min.js"></script>
	<script src="../node_modules/three/build/three.min.js"></script>
	<script src="../node_modules/three/examples/js/libs/inflate.min.js"></script>
	<script src="../node_modules/three/examples/js/loaders/AssimpLoader.js"></script>
	<script src="../node_modules/three/examples/js/loaders/ColladaLoader.js"></script>
	<script src="../node_modules/three/examples/js/loaders/FBXLoader.js"></script>
	<script src="../node_modules/three/examples/js/loaders/GLTFLoader.js"></script>
	<script src="../node_modules/three/examples/js/loaders/KMZLoader.js"></script>
	<script src="../node_modules/three/examples/js/loaders/OBJLoader.js"></script>
	<script src="../node_modules/three/examples/js/loaders/PLYLoader.js"></script>
	<script src="../node_modules/three/examples/js/loaders/PCDLoader.js"></script>
	<script src="../node_modules/three/examples/js/loaders/STLLoader.js"></script>
	<script src="../node_modules/three/examples/js/loaders/VTKLoader.js"></script>

	<script src="../ModelLoader.js"></script>

	<style>
		* {
			margin: 0;
			padding: 0;
			overflow: hidden;
		}

		#container {
			position: absolute;
			width: 100%;
		}

		#container > * {
			padding: 5px;
		}

		#error {
			background: #E91E63;
		}

		#error:empty {
			padding: 0;
		}

		div {
			color: white;
			text-align: center;
			pointer-events: none;
			font-family:Monospace;
			font-size:13px;
		}
	</style>
</head>
<body>
	<div id="container">
		<div id="error"></div>
		<div>Drag geometry files to load and view them </br>
		( Files with external dependencies will not load )</div>
	</div>
	
	<script>

		var errorel = document.getElementById( 'error' );
		var scene = new THREE.Scene();
		var camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 2000 );
		camera.position.set( 4, 5, 4 );
		camera.lookAt( new THREE.Vector3( 0, 0, 0 ) );

		var ambientLight = new THREE.AmbientLight( 0xcccccc, 0.4 );
		scene.add( ambientLight );

		var directionalLight = new THREE.DirectionalLight();
		directionalLight.position.set( 1, 1, 0 ).normalize();
		scene.add( directionalLight );

		var rotator = new THREE.Object3D();
		scene.add( rotator );

		var renderer = new THREE.WebGLRenderer( { antialiasing: true } );
		renderer.setPixelRatio( window.devicePixelRatio );
		renderer.setSize( window.innerWidth, window.innerHeight );
		renderer.setClearColor( 0x263238 );
		document.body.appendChild( renderer.domElement );

		// overriding the getLoader function so loaders can be
		// loaded as-needed
		var loader = new THREE.ModelLoader();
		loader.getLoader = function ( loaderName, manager, loadercb ) {

			function createLoader() {

				return new THREE[ loaderName ]( manager );

			}

			function getSource( name ) {
				
				var f =
					fetch( `../node_modules/three/examples/js/loaders/${ name }.js` )
						.then( res => res.text() )
				f.then( text => eval( text ) );

				return f;

			}

			if ( THREE[ loaderName ] == null ) {


				if ( loaderName === 'OBJLoader2' ) {

					getSource( 'LoaderSupport' )
						.then(() => getSource( loaderName ))
						.then(() => loadercb( createLoader() ));

				} else if ( loaderName === 'KMZLoader' ) {

					getSource( 'ColladaLoader' )
						.then(() => getSource( loaderName ))
						.then(() => loadercb( createLoader() ));

				} else {

					getSource( loaderName )
						.then(() => loadercb( createLoader() ));
				}

			} else {

				loadercb( createLoader() );

			}

		};
		
		function computeSceneBoundingSphere(root)
		{

			var sceneBSCenter = new THREE.Vector3(0, 0, 0), sceneBSRadius = 0;
			THREE.Object3D.prototype.traverse.call( root, function (object) {
			
				if (object instanceof THREE.Mesh) {
			
					// Object radius
					object.geometry.computeBoundingSphere();
					var radius = object.geometry.boundingSphere.radius;

					// Object center in world space
					var objectCenterLocal = object.position.clone();
					var objectCenterWorld = object.matrixWorld.multiplyVector3(objectCenterLocal);

					// New center in world space
					var newCenter = new THREE.Vector3();
					newCenter.add(sceneBSCenter, objectCenterWorld);
					newCenter.divideScalar(2.0);

					// New radius in world space
					var dCenter = newCenter.distanceTo(sceneBSCenter);
					var newRadius = Math.max(dCenter + radius, dCenter + sceneBSRadius);
					sceneBSCenter = newCenter;
					sceneBSRadius = newRadius;
			
				}
			
			} );
			
			return new THREE.Sphere( sceneBSCenter, sceneBSRadius );

		}


		document.addEventListener( 'dragover', e => e.preventDefault() );
		document.addEventListener( 'dragenter', e => e.preventDefault() );
		document.addEventListener( 'drop', e => {

			e.preventDefault();

			while (rotator.children.length) rotator.remove(rotator.children[0]);
			errorel.innerText = '';

			// Use DataTransfer interface to access the file(s)
			for ( var i = 0; i < e.dataTransfer.files.length; i ++ ) {

				var file = e.dataTransfer.files[ i ];
				var ext = file.name.match( /\.([^\.\\\/]+)$/ )[ 1 ];
				var url = URL.createObjectURL( file );
				loader.load( url, m => {

					var obj = m.scene || m.object || m;

					var sphere = computeSceneBoundingSphere( obj );
					var radius = sphere.radius;
					var s = 1 / radius;

					obj.position.set( 0, -0.5, 0 );
					obj.scale.set( s, s, s );

					rotator.add( obj );

				}, null, err => {

					errorel.innerText = err.message;

				}, ext );

			}

		} );

		window.addEventListener( 'resize', () => {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		} );

		( function renderLoop() {

			rotator.rotateY( 0.001 );
			renderer.render( scene, camera );
			requestAnimationFrame( renderLoop );

		} )();


	</script>
</body>
</html>